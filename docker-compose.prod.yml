# OpenGuardrails Docker Compose - Production Configuration
# Uses pre-built images from Docker Hub (no source code required)
#
# Usage:
#   1. Create .env file with PLATFORM_IMAGE=your-registry/openguardrails-platform:version
#   2. Run: docker compose -f docker-compose.prod.yml up -d

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: openguardrails-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: openguardrails
      POSTGRES_USER: openguardrails
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-your_password}
      POSTGRES_HOST_AUTH_METHOD: md5
    command: [
      "postgres",
      "-c", "max_connections=600",
      "-c", "shared_buffers=256MB",
      "-c", "effective_cache_size=1GB",
      "-c", "maintenance_work_mem=64MB",
      "-c", "checkpoint_completion_target=0.9",
      "-c", "wal_buffers=16MB",
      "-c", "default_statistics_target=100",
      "-c", "random_page_cost=1.1",
      "-c", "effective_io_concurrency=200",
      "-c", "work_mem=4MB"
    ]
    ports:
      - "${POSTGRES_PORT:-54321}:5432"
    volumes:
      - openguardrails-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openguardrails -d openguardrails"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - openguardrails-network

  # Unified Platform Service (Frontend + Backend)
  # Production mode: Uses pre-built image from registry
  platform:
    image: ${PLATFORM_IMAGE:-openguardrails/openguardrails-platform:latest}
    container_name: openguardrails-platform
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
      - "${ADMIN_PORT:-5000}:5000"
      - "${DETECTION_PORT:-5001}:5001"
      - "${PROXY_PORT:-5002}:5002"
    environment:
      # Database configuration
      - DATABASE_HOST=${DATABASE_HOST:-postgres}
      - DATABASE_USER=${DATABASE_USER:-openguardrails}
      - DATABASE_NAME=${DATABASE_NAME:-openguardrails}
      - DATABASE_URL=postgresql://${DATABASE_USER:-openguardrails}:${POSTGRES_PASSWORD:-your_password}@${DATABASE_HOST:-postgres}:5432/${DATABASE_NAME:-openguardrails}
      - RESET_DATABASE_ON_STARTUP=false

      # Application configuration
      - DEBUG=${DEBUG:-false}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      - DEPLOYMENT_MODE=${DEPLOYMENT_MODE:-local}

      # Data directory configuration
      - DATA_DIR=/app/data
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # CORS configuration
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}

      # Administrator configuration
      - SUPER_ADMIN_USERNAME=${SUPER_ADMIN_USERNAME:-admin@yourdomain.com}
      - SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD:-CHANGE-THIS-PASSWORD-IN-PRODUCTION}

      # Default language configuration
      - DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE:-en}

      # Model API configuration (OpenGuardrails Text Model)
      - GUARDRAILS_MODEL_API_URL=${GUARDRAILS_MODEL_API_URL:-http://localhost:58002/v1}
      - GUARDRAILS_MODEL_API_KEY=${GUARDRAILS_MODEL_API_KEY:-EMPTY}
      - GUARDRAILS_MODEL_NAME=${GUARDRAILS_MODEL_NAME:-OpenGuardrails-Text}

      # Multimodal model API configuration (Vision-Language)
      - GUARDRAILS_VL_MODEL_API_URL=${GUARDRAILS_VL_MODEL_API_URL:-http://localhost:58003/v1}
      - GUARDRAILS_VL_MODEL_API_KEY=${GUARDRAILS_VL_MODEL_API_KEY:-EMPTY}
      - GUARDRAILS_VL_MODEL_NAME=${GUARDRAILS_VL_MODEL_NAME:-OpenGuardrails-VL}

      # Embedding model API configuration
      - EMBEDDING_API_BASE_URL=${EMBEDDING_API_BASE_URL:-http://localhost:58004/v1}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY:-EMPTY}
      - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-bge-m3}
      - EMBEDDING_MODEL_DIMENSION=${EMBEDDING_MODEL_DIMENSION:-1024}
      - EMBEDDING_SIMILARITY_THRESHOLD=${EMBEDDING_SIMILARITY_THRESHOLD:-0.7}
      - EMBEDDING_MAX_RESULTS=${EMBEDDING_MAX_RESULTS:-5}

      # SMTP email configuration
      - SMTP_SERVER=${SMTP_SERVER:-smtp.yourdomain.com}
      - SMTP_PORT=${SMTP_PORT:-465}
      - SMTP_USERNAME=${SMTP_USERNAME:-your-email@yourdomain.com}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-your-password}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-false}
      - SMTP_USE_SSL=${SMTP_USE_SSL:-true}

      # Service configuration
      - ADMIN_PORT=5000
      - ADMIN_UVICORN_WORKERS=${ADMIN_UVICORN_WORKERS:-2}
      - ADMIN_MAX_CONCURRENT_REQUESTS=${ADMIN_MAX_CONCURRENT_REQUESTS:-50}

      - DETECTION_PORT=5001
      - DETECTION_UVICORN_WORKERS=${DETECTION_UVICORN_WORKERS:-32}
      - DETECTION_MAX_CONCURRENT_REQUESTS=${DETECTION_MAX_CONCURRENT_REQUESTS:-400}
      - DETECTION_HOST=${DETECTION_HOST:-localhost}

      - PROXY_PORT=5002
      - PROXY_UVICORN_WORKERS=${PROXY_UVICORN_WORKERS:-24}
      - PROXY_MAX_CONCURRENT_REQUESTS=${PROXY_MAX_CONCURRENT_REQUESTS:-300}

      # Frontend configuration
      - VITE_BASE=/platform/

    volumes:
      - openguardrails-platform-data:/mnt/data/openguardrails-data
    depends_on:
      postgres:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - openguardrails-network
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:5000/health && curl -f http://localhost:5001/health && curl -f http://localhost:5002/health && curl -f http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  openguardrails-network:
    driver: bridge

volumes:
  openguardrails-db-data:
    driver: local
  openguardrails-platform-data:
    driver: local
