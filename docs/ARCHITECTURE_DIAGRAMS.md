# OpenGuardrails 架构设计图

> 用于技术交流的系统架构图集

---

## 1. 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              OpenGuardrails Platform                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                           Client Layer                                    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │   │
│  │  │   Web UI    │  │  REST API   │  │OpenAI SDK   │  │ Third-party     │  │   │
│  │  │  (React)    │  │   Client    │  │ Compatible  │  │ Integrations    │  │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘  │   │
│  └─────────┼────────────────┼────────────────┼──────────────────┼───────────┘   │
│            │                │                │                  │               │
│            ▼                ▼                ▼                  ▼               │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                        Nginx Reverse Proxy (:3000)                        │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐   │   │
│  │  │ /platform/* → UI │  │ /api/* → Admin  │  │ /v1/* → Detection/Proxy │   │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                         Service Layer (FastAPI)                           │   │
│  │                                                                           │   │
│  │  ┌────────────────────┐  ┌──────────────────┐  ┌─────────────────────┐   │   │
│  │  │   Admin Service    │  │ Detection Service│  │   Proxy Service     │   │   │
│  │  │     Port 5000      │  │    Port 5001     │  │    Port 5002        │   │   │
│  │  │   (2 workers)      │  │  (32 workers)    │  │   (24 workers)      │   │   │
│  │  │                    │  │                  │  │                     │   │   │
│  │  │ • User Management  │  │ • Guardrail API  │  │ • Chat Completions  │   │   │
│  │  │ • Config CRUD      │  │ • Risk Detection │  │ • Input Detection   │   │   │
│  │  │ • Dashboard        │  │ • Ban Policy     │  │ • Output Detection  │   │   │
│  │  │ • Migration Runner │  │ • Async Logging  │  │ • Model Routing     │   │   │
│  │  │ • Billing/Payment  │  │                  │  │ • DLP Processing    │   │   │
│  │  └─────────┬──────────┘  └────────┬─────────┘  └──────────┬──────────┘   │   │
│  └────────────┼──────────────────────┼───────────────────────┼──────────────┘   │
│               │                      │                       │                  │
│               ▼                      ▼                       ▼                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                         Middleware Layer                                  │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ Auth Context │  │  Rate Limit  │  │   Billing    │  │  Concurrent  │  │   │
│  │  │  Middleware  │  │  Middleware  │  │  Middleware  │  │    Limit     │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                        Business Logic Layer                               │   │
│  │                                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │   │
│  │  │                     Core Detection Services                          │ │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐   │ │   │
│  │  │  │  Guardrail   │  │   Scanner    │  │   Model Service          │   │ │   │
│  │  │  │   Service    │  │   Service    │  │ (OpenGuardrails-Text)    │   │ │   │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │   │
│  │  │                Data Leakage Prevention Services                      │ │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐   │ │   │
│  │  │  │   Format     │  │ Segmentation │  │   Data Security          │   │ │   │
│  │  │  │  Detection   │  │   Service    │  │     Service              │   │ │   │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────────────┘   │ │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐   │ │   │
│  │  │  │  Disposal    │  │ Anonymization│  │   Restore Service        │   │ │   │
│  │  │  │   Service    │  │   Service    │  │                          │   │ │   │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │   │
│  │  │                    Configuration Services                            │ │   │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐   │ │   │
│  │  │  │   Keyword    │  │   Template   │  │   Risk Config            │   │ │   │
│  │  │  │   Service    │  │   Service    │  │     Service              │   │ │   │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                         Cache Layer (5min TTL)                            │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │  Auth Cache  │  │Keyword Cache │  │ Config Cache │  │Template Cache│  │   │
│  │  │   (1h TTL)   │  │  (5min TTL)  │  │  (5min TTL)  │  │  (5min TTL)  │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              External Services                                   │
│                                                                                  │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────────────┐ │
│  │    PostgreSQL      │  │  OpenGuardrails    │  │      Embedding Model       │ │
│  │   (Port 54321)     │  │   Text Model       │  │      (BAAI/bge-m3)         │ │
│  │                    │  │   (Port 58002)     │  │      (Port 58004)          │ │
│  │ • User Data        │  │                    │  │                            │ │
│  │ • Detection Logs   │  │ • Safety Detection │  │ • Knowledge Base           │ │
│  │ • Configurations   │  │ • 19 Risk Types    │  │ • Similarity Search        │ │
│  │ • Scanner Packages │  │ • 119 Languages    │  │ • Vector Embeddings        │ │
│  └────────────────────┘  └────────────────────┘  └────────────────────────────┘ │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                         Upstream LLM Providers                             │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐ │ │
│  │  │  OpenAI  │  │ Anthropic│  │  Azure   │  │  Groq    │  │ Private/     │ │ │
│  │  │          │  │          │  │  OpenAI  │  │          │  │ On-Premise   │ │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心检测流程 (Detection Flow)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Detection API Flow (/v1/guardrails)                      │
└─────────────────────────────────────────────────────────────────────────────────┘

     User Request
          │
          ▼
    ┌───────────┐
    │   Auth    │─────────────────────────────────────────┐
    │Middleware │                                         │
    └─────┬─────┘                                         │
          │ ✓ Authenticated                               │ ✗ 401 Unauthorized
          ▼                                               ▼
    ┌───────────┐                                   ┌───────────┐
    │ Ban Check │                                   │  Return   │
    │  Service  │                                   │   Error   │
    └─────┬─────┘                                   └───────────┘
          │
          │ ✓ Not Banned                    ✗ Banned
          ├─────────────────────────────────────────────────┐
          ▼                                                 │
    ┌───────────┐                                           │
    │ Rate/Quota│                                           │
    │   Check   │                                           │
    └─────┬─────┘                                           │
          │                                                 │
          │ ✓ Within Limits                ✗ Exceeded       │
          ├─────────────────────────────────────────┐       │
          ▼                                         │       │
    ┌─────────────────┐                             │       │
    │  Whitelist      │                             │       │
    │  Check          │──── Match ────────────────────────────────┐
    └─────┬───────────┘                             │       │     │
          │ No Match                                │       │     │
          ▼                                         │       │     │
    ┌─────────────────┐                             │       │     │
    │  Blacklist      │                             │       │     │
    │  Check          │──── Match ───────────────────────────────────┐
    └─────┬───────────┘                             │       │     │  │
          │ No Match                                │       │     │  │
          ▼                                         │       │     │  │
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                      Model Detection (OpenGuardrails-Text)              │
    │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
    │  │Security Scanners│  │Compliance Scan  │  │   Data Security Scan    │  │
    │  │   (S1-S21)      │  │    (Legacy)     │  │  (Regex + GenAI)        │  │
    │  └────────┬────────┘  └────────┬────────┘  └───────────┬─────────────┘  │
    │           │                    │                       │                │
    │           └────────────────────┼───────────────────────┘                │
    │                                │                                        │
    │                    ┌───────────▼───────────┐                            │
    │                    │   Sliding Window      │                            │
    │                    │   (Long Content)      │                            │
    │                    │   • Parallel windows  │                            │
    │                    │   • 20% overlap       │                            │
    │                    └───────────┬───────────┘                            │
    └────────────────────────────────┼────────────────────────────────────────┘
                                     │
                                     ▼
                        ┌────────────────────────┐
                        │   Risk Aggregation     │
                        │                        │
                        │ security_risk_level    │
                        │ compliance_risk_level  │
                        │ data_risk_level        │
                        │         ↓              │
                        │ overall = max(all)     │
                        └───────────┬────────────┘
                                    │
           ┌────────────────────────┼────────────────────────┐
           │                        │                        │
           ▼                        ▼                        ▼
    ┌──────────────┐        ┌──────────────┐        ┌──────────────┐
    │  High Risk   │        │ Medium Risk  │        │  Low Risk    │
    │              │        │              │        │              │
    │  Action:     │        │  Action:     │        │  Action:     │
    │  REJECT      │        │  REPLACE     │        │  PASS        │
    │              │        │              │        │              │
    │  Response:   │        │  Response:   │        │  Response:   │
    │  Template    │        │ Knowledge    │        │  None        │
    │              │        │    Base      │        │              │
    └──────┬───────┘        └──────┬───────┘        └──────┬───────┘
           │                       │                       │
           └───────────────────────┼───────────────────────┘
                                   │
                                   ▼
                        ┌────────────────────────┐
                        │   Ban Policy Check     │
                        │   (Update triggers)    │
                        └───────────┬────────────┘
                                    │
                                    ▼
                        ┌────────────────────────┐
                        │   Async Log to File    │
                        │   (Non-blocking)       │
                        └───────────┬────────────┘
                                    │
                                    ▼
                        ┌────────────────────────┐
                        │   Return Response      │
                        │   {                    │
                        │     id,                │
                        │     overall_risk,      │
                        │     suggest_action,    │  ◄── PASS
                        │     suggest_answer     │  ◄── REJECT/REPLACE
                        │   }                    │
                        └────────────────────────┘
```

---

## 3. Security Gateway (Proxy) 流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                  Security Gateway Flow (/v1/chat/completions)                    │
└─────────────────────────────────────────────────────────────────────────────────┘

     Client Request (OpenAI-compatible)
          │
          ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                     Authentication & Setup                       │
    │   • API Key verification                                        │
    │   • Application auto-discovery (X-OG-Application-ID)            │
    │   • Ban status check                                            │
    │   • Upstream model selection                                    │
    └───────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                      INPUT DETECTION                             │
    │                                                                  │
    │  ┌────────────────────────────────────────────────────────────┐ │
    │  │                 Data Leakage Detection                      │ │
    │  │                                                             │ │
    │  │   ┌──────────────┐    ┌──────────────┐   ┌──────────────┐  │ │
    │  │   │   Format     │ -> │ Segmentation │ ->│    Entity    │  │ │
    │  │   │  Detection   │    │   Service    │   │  Detection   │  │ │
    │  │   │              │    │              │   │              │  │ │
    │  │   │ • JSON       │    │ • JSON: 50   │   │ • Regex      │  │ │
    │  │   │ • YAML       │    │ • YAML: 50   │   │   (全文)     │  │ │
    │  │   │ • CSV        │    │ • CSV: 100   │   │ • GenAI      │  │ │
    │  │   │ • Markdown   │    │ • MD: 30     │   │   (按段)     │  │ │
    │  │   │ • Plain Text │    │ • Text: 1    │   │              │  │ │
    │  │   └──────────────┘    └──────────────┘   └──────────────┘  │ │
    │  └────────────────────────────────────────────────────────────┘ │
    │                                                                  │
    │  ┌────────────────────────────────────────────────────────────┐ │
    │  │                General Security Detection                   │ │
    │  │                    (S1-S21 Scanners)                        │ │
    │  └────────────────────────────────────────────────────────────┘ │
    └───────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    INPUT POLICY DECISION                         │
    │                                                                  │
    │        ┌─────────────────────────────────────────────────┐      │
    │        │           Risk Level Detected                    │      │
    │        └──────────────────────┬──────────────────────────┘      │
    │                               │                                  │
    │         ┌─────────────────────┼─────────────────────┐           │
    │         ▼                     ▼                     ▼           │
    │   ┌───────────┐         ┌───────────┐         ┌───────────┐    │
    │   │ High Risk │         │Medium Risk│         │ Low Risk  │    │
    │   └─────┬─────┘         └─────┬─────┘         └─────┬─────┘    │
    │         │                     │                     │           │
    │         ▼                     ▼                     ▼           │
    │   Policy Action:        Policy Action:        Policy Action:    │
    │   ┌──────────┐          ┌──────────┐          ┌──────────┐     │
    │   │  BLOCK   │ (默认)   │ANONYMIZE │ (默认)   │ANONYMIZE │(默认)│
    │   │  SWITCH  │          │  SWITCH  │          │  SWITCH  │     │
    │   │ANONYMIZE │          │  BLOCK   │          │  BLOCK   │     │
    │   │  PASS    │          │   PASS   │          │   PASS   │     │
    │   └──────────┘          └──────────┘          └──────────┘     │
    └───────────────────────────┬─────────────────────────────────────┘
                                │
          ┌─────────────────────┼─────────────────────┐
          ▼                     ▼                     ▼
    ┌───────────┐         ┌───────────┐         ┌───────────┐
    │   BLOCK   │         │  SWITCH   │         │ ANONYMIZE │
    │           │         │  PRIVATE  │         │           │
    │  Return   │         │   MODEL   │         │ Replace   │
    │  Error    │         │           │         │ Sensitive │
    │  403      │         │ Route to  │         │  Entities │
    └───────────┘         │ On-Premise│         └─────┬─────┘
                          │   Model   │               │
                          └─────┬─────┘               │
                                │                     │
                                └──────────┬──────────┘
                                           │
                                           ▼
                            ┌────────────────────────┐
                            │   Forward to Upstream  │
                            │      LLM Provider      │
                            │                        │
                            │  • OpenAI / Azure      │
                            │  • Anthropic           │
                            │  • Private Model       │
                            └───────────┬────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                      OUTPUT DETECTION                            │
    │                                                                  │
    │   ┌───────────────────────────────────────────────────────────┐ │
    │   │                  Stream Mode                               │ │
    │   │   • Chunk detection (每 N 个 chunks)                      │ │
    │   │   • Real-time risk checking                               │ │
    │   └───────────────────────────────────────────────────────────┘ │
    │                              OR                                  │
    │   ┌───────────────────────────────────────────────────────────┐ │
    │   │              Non-Stream Mode                               │ │
    │   │   • Complete response detection                           │ │
    │   │   • Full content analysis                                 │ │
    │   └───────────────────────────────────────────────────────────┘ │
    └───────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    OUTPUT POLICY DECISION                        │
    │        (同 INPUT, 支持 block/anonymize/switch/pass)             │
    └───────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    Response Processing                           │
    │                                                                  │
    │   • Restore anonymization (if applicable)                       │
    │   • Log proxy request                                           │
    │   • Return to client                                            │
    └───────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
                          Client Response
```

---

## 4. 数据泄露防护 (DLP) 详细流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Data Leakage Prevention (DLP) System                          │
└─────────────────────────────────────────────────────────────────────────────────┘

     Input Content
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Stage 1: Format Detection (~5-10ms)                                             │
│                                                                                  │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │                    Format Detection Service                            │    │
│    │                                                                        │    │
│    │   Content Analysis:                                                    │    │
│    │   • Check for JSON: starts with { or [, valid JSON structure          │    │
│    │   • Check for YAML: contains ":" patterns, valid YAML structure       │    │
│    │   • Check for CSV: comma-separated, consistent columns                │    │
│    │   • Check for Markdown: ## headers, lists, code blocks                │    │
│    │   • Default: Plain Text                                               │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│    Detected Format: JSON | YAML | CSV | Markdown | Plain Text                   │
└───────────────────────────────────────────┬─────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Stage 2: Smart Segmentation (~10-20ms)                                          │
│                                                                                  │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │                    Segmentation Service                                │    │
│    │                                                                        │    │
│    │   Format-Specific Strategies:                                          │    │
│    │                                                                        │    │
│    │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │    │
│    │   │    JSON      │  │    YAML      │  │     CSV      │                │    │
│    │   │              │  │              │  │              │                │    │
│    │   │ Split by     │  │ Split by     │  │ Split by     │                │    │
│    │   │ top-level    │  │ top-level    │  │ rows with    │                │    │
│    │   │ objects      │  │ keys         │  │ header       │                │    │
│    │   │              │  │              │  │ retention    │                │    │
│    │   │ Max: 50      │  │ Max: 50      │  │ Max: 100     │                │    │
│    │   └──────────────┘  └──────────────┘  └──────────────┘                │    │
│    │                                                                        │    │
│    │   ┌──────────────┐  ┌──────────────┐                                  │    │
│    │   │   Markdown   │  │  Plain Text  │                                  │    │
│    │   │              │  │              │                                  │    │
│    │   │ Split by     │  │ Single       │                                  │    │
│    │   │ ## sections  │  │ segment      │                                  │    │
│    │   │              │  │ (no split)   │                                  │    │
│    │   │ Max: 30      │  │              │                                  │    │
│    │   └──────────────┘  └──────────────┘                                  │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│    Output: [Segment 1, Segment 2, ..., Segment N]                               │
└───────────────────────────────────────────┬─────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Stage 3: Entity Detection (Parallel Processing)                                 │
│                                                                                  │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │                    Data Security Service                               │    │
│    │                                                                        │    │
│    │   ┌─────────────────────────────────────────────────────────────────┐ │    │
│    │   │                 Regex Detection (Full Text)                      │ │    │
│    │   │                                                                  │ │    │
│    │   │   Applied to entire content (not per-segment):                  │ │    │
│    │   │   • ID Cards (身份证号)                                         │ │    │
│    │   │   • Credit Cards (信用卡号)                                     │ │    │
│    │   │   • Phone Numbers (电话号码)                                    │ │    │
│    │   │   • Email Addresses (邮箱)                                      │ │    │
│    │   │   • Bank Accounts (银行账号)                                    │ │    │
│    │   │   • Custom Regex Patterns                                       │ │    │
│    │   └─────────────────────────────────────────────────────────────────┘ │    │
│    │                                                                        │    │
│    │   ┌─────────────────────────────────────────────────────────────────┐ │    │
│    │   │              GenAI Detection (Per Segment, Parallel)            │ │    │
│    │   │                                                                  │ │    │
│    │   │   ┌─────────┐  ┌─────────┐  ┌─────────┐      ┌─────────┐       │ │    │
│    │   │   │Segment 1│  │Segment 2│  │Segment 3│ ...  │Segment N│       │ │    │
│    │   │   │         │  │         │  │         │      │         │       │ │    │
│    │   │   │  GenAI  │  │  GenAI  │  │  GenAI  │      │  GenAI  │       │ │    │
│    │   │   │ Analyze │  │ Analyze │  │ Analyze │      │ Analyze │       │ │    │
│    │   │   └────┬────┘  └────┬────┘  └────┬────┘      └────┬────┘       │ │    │
│    │   │        │            │            │                │            │ │    │
│    │   │        └────────────┴────────────┴────────────────┘            │ │    │
│    │   │                              │                                  │ │    │
│    │   │                              ▼                                  │ │    │
│    │   │                    Parallel Execution                          │ │    │
│    │   │               (20-60% faster for >1KB)                         │ │    │
│    │   └─────────────────────────────────────────────────────────────────┘ │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│    Detected Entities:                                                           │
│    [                                                                            │
│      {type: "ID_CARD", value: "...", position: ..., risk: "high"},             │
│      {type: "CREDIT_CARD", value: "...", position: ..., risk: "medium"},       │
│      {type: "CUSTOM_ENTITY", value: "...", position: ..., risk: "low"},        │
│      ...                                                                        │
│    ]                                                                            │
└───────────────────────────────────────────┬─────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Stage 4: Risk Aggregation                                                       │
│                                                                                  │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │                                                                        │    │
│    │   Entity Risks:   HIGH    MEDIUM    LOW                               │    │
│    │                     │        │        │                                │    │
│    │                     └────────┴────────┘                                │    │
│    │                              │                                         │    │
│    │                              ▼                                         │    │
│    │                    Overall Risk = MAX(all entity risks)               │    │
│    │                                                                        │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│    data_risk_level: "high" | "medium" | "low" | "none"                          │
│    data_categories: ["ID_CARD", "CREDIT_CARD", ...]                             │
└───────────────────────────────────────────┬─────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Stage 5: Disposal Action                                                        │
│                                                                                  │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │                    Data Leakage Disposal Service                       │    │
│    │                                                                        │    │
│    │   Policy Lookup: Application Policy → Tenant Policy → System Default  │    │
│    │                                                                        │    │
│    │   ┌─────────────────────────────────────────────────────────────────┐ │    │
│    │   │  Risk Level  │        Available Actions                         │ │    │
│    │   ├──────────────┼──────────────────────────────────────────────────┤ │    │
│    │   │  HIGH        │  BLOCK (default) | SWITCH | ANONYMIZE | PASS    │ │    │
│    │   │  MEDIUM      │  ANONYMIZE (default) | BLOCK | SWITCH | PASS    │ │    │
│    │   │  LOW         │  ANONYMIZE (default) | BLOCK | SWITCH | PASS    │ │    │
│    │   └─────────────────────────────────────────────────────────────────┘ │    │
│    │                                                                        │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│    Action Execution:                                                            │
│                                                                                  │
│    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│    │    BLOCK     │  │    SWITCH    │  │  ANONYMIZE   │  │     PASS     │       │
│    │              │  │              │  │              │  │              │       │
│    │ Reject with  │  │ Redirect to  │  │ Replace with │  │ Allow, log   │       │
│    │ error 403    │  │ private      │  │ placeholders │  │ only         │       │
│    │              │  │ model        │  │              │  │              │       │
│    │              │  │              │  │ [ID_CARD_1]  │  │              │       │
│    │              │  │ Selection:   │  │ [PHONE_2]    │  │              │       │
│    │              │  │ 1.App policy │  │ ...          │  │              │       │
│    │              │  │ 2.Tenant def │  │              │  │              │       │
│    │              │  │ 3.Priority   │  │              │  │              │       │
│    └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 私有模型切换机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Private Model Selection & Switching                           │
└─────────────────────────────────────────────────────────────────────────────────┘

                    Sensitive Data Detected
                    (Policy: switch_private_model)
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       Private Model Selection                                    │
│                                                                                  │
│    Priority 1: Application-Level Override                                       │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │  application_data_leakage_policies.private_model_id                    │    │
│    │  (Explicit configuration for this specific application)                │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                              │                                                   │
│                              │ NULL?                                            │
│                              ▼                                                   │
│    Priority 2: Tenant Default Private Model                                     │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │  upstream_api_configs WHERE is_default_private_model = TRUE            │    │
│    │  (Tenant-wide default for all applications)                            │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                              │                                                   │
│                              │ Not found?                                       │
│                              ▼                                                   │
│    Priority 3: Highest Priority Private Model                                   │
│    ┌───────────────────────────────────────────────────────────────────────┐    │
│    │  upstream_api_configs WHERE is_data_safe = TRUE                        │    │
│    │  ORDER BY private_model_priority DESC                                  │    │
│    │  (Select based on priority ranking 0-100)                              │    │
│    └───────────────────────────────────────────────────────────────────────┘    │
│                              │                                                   │
└──────────────────────────────┼──────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      Private Model Configuration                                 │
│                                                                                  │
│    upstream_api_configs table:                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │  Field                      │  Description                              │  │
│    ├─────────────────────────────┼───────────────────────────────────────────┤  │
│    │  is_data_safe               │  Mark as safe for sensitive data          │  │
│    │                             │  (on-premise, private cloud, air-gapped)  │  │
│    ├─────────────────────────────┼───────────────────────────────────────────┤  │
│    │  is_default_private_model   │  Tenant-wide default private model        │  │
│    ├─────────────────────────────┼───────────────────────────────────────────┤  │
│    │  private_model_priority     │  Priority ranking (0-100, higher=prefer)  │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    Example Configuration:                                                       │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │  Model Name       │ is_data_safe │ is_default │ priority               │  │
│    ├───────────────────┼──────────────┼────────────┼─────────────────────── │  │
│    │  GPT-4 (OpenAI)   │     ✗        │     ✗      │    -                   │  │
│    │  Claude (API)     │     ✗        │     ✗      │    -                   │  │
│    │  Qwen-Private     │     ✓        │     ✓      │   100                  │  │
│    │  DeepSeek-Local   │     ✓        │     ✗      │    80                  │  │
│    │  LLaMA-OnPremise  │     ✓        │     ✗      │    60                  │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Request Routing                                         │
│                                                                                  │
│    Original Request                    Routed Request                           │
│    ┌────────────────────┐             ┌────────────────────┐                    │
│    │                    │             │                    │                    │
│    │  Target: GPT-4     │  ────────>  │  Target: Qwen-     │                    │
│    │  (Public Cloud)    │             │  Private           │                    │
│    │                    │             │  (On-Premise)      │                    │
│    │  Content:          │             │                    │                    │
│    │  "Process this     │             │  Content:          │                    │
│    │   customer data:   │             │  (Unchanged -      │                    │
│    │   ID: 310..."      │             │   data stays safe) │                    │
│    │                    │             │                    │                    │
│    └────────────────────┘             └────────────────────┘                    │
│                                                                                  │
│    User Experience: Seamless, no interruption, data never leaves infrastructure │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 数据库 ER 图 (核心表)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Core Database Schema                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌────────────────────┐
                              │      tenants       │
                              ├────────────────────┤
                              │ id (PK)            │
                              │ email              │
                              │ password_hash      │
                              │ api_key            │
                              │ is_super_admin     │
                              │ language           │
                              └─────────┬──────────┘
                                        │
            ┌───────────────────────────┼───────────────────────────┐
            │                           │                           │
            ▼                           ▼                           ▼
┌────────────────────┐    ┌────────────────────┐    ┌────────────────────────┐
│   applications     │    │tenant_subscriptions│    │ upstream_api_configs   │
├────────────────────┤    ├────────────────────┤    ├────────────────────────┤
│ id (PK)            │    │ id (PK)            │    │ id (PK)                │
│ tenant_id (FK)     │    │ tenant_id (FK)     │    │ tenant_id (FK)         │
│ name               │    │ subscription_type  │    │ config_name            │
│ description        │    │ monthly_quota      │    │ api_base_url           │
│ is_active          │    │ current_usage      │    │ api_key_encrypted      │
│ source             │    │ stripe_customer_id │    │ provider               │
│ external_id        │    └────────────────────┘    │ is_data_safe           │
└─────────┬──────────┘                              │ is_default_private     │
          │                                         │ private_model_priority │
          │                                         └────────────────────────┘
          │
          ├────────────────────────────────────────────────────────┐
          │                                                        │
          ▼                                                        ▼
┌────────────────────┐                              ┌────────────────────────────┐
│     api_keys       │                              │     detection_results      │
├────────────────────┤                              ├────────────────────────────┤
│ id (PK)            │                              │ id (PK)                    │
│ tenant_id (FK)     │                              │ tenant_id (FK)             │
│ application_id(FK) │                              │ application_id (FK)        │
│ key                │                              │ request_id                 │
│ name               │                              │ content                    │
│ is_active          │                              │ overall_risk_level         │
│ last_used_at       │                              │ security_risk_level        │
└────────────────────┘                              │ security_categories        │
                                                    │ compliance_risk_level      │
                                                    │ data_risk_level            │
                                                    │ data_categories            │
                                                    │ suggest_action             │
                                                    │ suggest_answer             │
                                                    │ ip_address                 │
                                                    │ created_at                 │
                                                    └────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────┐
│                          Configuration Tables                                  │
└───────────────────────────────────────────────────────────────────────────────┘

┌────────────────────┐    ┌────────────────────┐    ┌────────────────────┐
│     blacklist      │    │     whitelist      │    │response_templates  │
├────────────────────┤    ├────────────────────┤    ├────────────────────┤
│ id (PK)            │    │ id (PK)            │    │ id (PK)            │
│ tenant_id (FK)     │    │ tenant_id (FK)     │    │ tenant_id (FK)     │
│ application_id(FK) │    │ application_id(FK) │    │ application_id(FK) │
│ keywords (JSON)    │    │ keywords (JSON)    │    │ scanner_type       │
│ is_active          │    │ is_active          │    │ scanner_identifier │
└────────────────────┘    └────────────────────┘    │ template_content   │
                                                    │ risk_level         │
                                                    └────────────────────┘

┌────────────────────┐    ┌────────────────────┐    ┌────────────────────┐
│ risk_type_config   │    │   ban_policies     │    │ user_ban_records   │
├────────────────────┤    ├────────────────────┤    ├────────────────────┤
│ id (PK)            │    │ id (PK)            │    │ id (PK)            │
│ tenant_id (FK)     │    │ tenant_id (FK)     │    │ tenant_id (FK)     │
│ application_id(FK) │    │ application_id(FK) │    │ application_id(FK) │
│ s1_enabled..s21    │    │ enabled            │    │ user_id            │
│ high_sensitivity   │    │ risk_level         │    │ banned_at          │
│ medium_sensitivity │    │ trigger_count      │    │ ban_until          │
│ low_sensitivity    │    │ time_window_min    │    │ is_active          │
└────────────────────┘    │ ban_duration_min   │    └────────────────────┘
                          └────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────┐
│                      Data Leakage Prevention Tables                            │
└───────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────┐         ┌─────────────────────────────────┐
│ data_security_entity_types      │         │ tenant_data_leakage_policies    │
├─────────────────────────────────┤         ├─────────────────────────────────┤
│ id (PK)                         │         │ id (PK)                         │
│ tenant_id (FK)                  │         │ tenant_id (FK)                  │
│ application_id (FK)             │         │ default_input_high_risk_action  │
│ entity_type                     │         │ default_input_medium_risk_action│
│ entity_type_name                │         │ default_input_low_risk_action   │
│ category (high/medium/low)      │         │ default_output_high_risk_action │
│ recognition_method (regex)      │         │ default_output_medium_risk_action│
│ recognition_config (JSON)       │         │ default_output_low_risk_action  │
│ anonymization_method            │         │ default_enable_format_detection │
│ anonymization_config (JSON)     │         │ default_enable_smart_segment    │
└─────────────────────────────────┘         └─────────────────────────────────┘

┌─────────────────────────────────┐
│application_data_leakage_policies│
├─────────────────────────────────┤
│ id (PK)                         │
│ tenant_id (FK)                  │
│ application_id (FK)             │
│ input_high_risk_action          │ ◄── block | switch_private_model |
│ input_medium_risk_action        │     anonymize | pass (NULL=inherit)
│ input_low_risk_action           │
│ output_high_risk_action         │
│ output_medium_risk_action       │
│ output_low_risk_action          │
│ private_model_id (FK)           │ ◄── Override private model
│ enable_format_detection         │
│ enable_smart_segmentation       │
└─────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────────┐
│                         Scanner Package Tables                                 │
└───────────────────────────────────────────────────────────────────────────────┘

┌────────────────────┐         ┌────────────────────┐
│  scanner_packages  │ 1:N     │     scanners       │
├────────────────────┤────────>├────────────────────┤
│ id (PK)            │         │ id (PK)            │
│ package_code       │         │ package_id (FK)    │
│ package_name       │         │ tag (S1, S2...)    │
│ package_type       │         │ name               │
│ is_official        │         │ scanner_type       │
│ requires_purchase  │         │ definition (JSON)  │
│ price              │         │ default_risk_level │
│ is_active          │         │ is_active          │
└────────────────────┘         └─────────┬──────────┘
         │                               │
         │                               │
         ▼                               ▼
┌────────────────────┐         ┌────────────────────────────┐
│ package_purchases  │         │ application_scanner_configs│
├────────────────────┤         ├────────────────────────────┤
│ id (PK)            │         │ id (PK)                    │
│ tenant_id (FK)     │         │ application_id (FK)        │
│ package_id (FK)    │         │ scanner_id (FK)            │
│ status             │         │ is_enabled                 │
│ approved_by        │         │ risk_level_override        │
│ approved_at        │         │ scan_prompt_override       │
└────────────────────┘         └────────────────────────────┘
```

---

## 7. 多层配置继承机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Multi-Level Configuration Inheritance                         │
└─────────────────────────────────────────────────────────────────────────────────┘

    Configuration Lookup Priority:

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                          │
    │   Level 1: Application-Specific Configuration                           │
    │   ┌──────────────────────────────────────────────────────────────────┐  │
    │   │  tenant_id = X, application_id = Y                                │  │
    │   │                                                                   │  │
    │   │  Most specific, highest priority                                  │  │
    │   │  NULL values → inherit from Level 2                               │  │
    │   └───────────────────────────────┬──────────────────────────────────┘  │
    │                                   │                                      │
    │                                   │ If NULL                             │
    │                                   ▼                                      │
    │   Level 2: Tenant Default Configuration                                 │
    │   ┌──────────────────────────────────────────────────────────────────┐  │
    │   │  tenant_id = X, application_id = NULL                             │  │
    │   │                                                                   │  │
    │   │  Tenant-wide defaults, applies to all apps                        │  │
    │   │  NULL values → inherit from Level 3                               │  │
    │   └───────────────────────────────┬──────────────────────────────────┘  │
    │                                   │                                      │
    │                                   │ If NULL                             │
    │                                   ▼                                      │
    │   Level 3: System Default Configuration                                 │
    │   ┌──────────────────────────────────────────────────────────────────┐  │
    │   │  tenant_id = NULL, application_id = NULL                          │  │
    │   │                                                                   │  │
    │   │  System-wide defaults                                             │  │
    │   │  Hardcoded fallback values                                        │  │
    │   └──────────────────────────────────────────────────────────────────┘  │
    │                                                                          │
    └─────────────────────────────────────────────────────────────────────────┘

    Example: Data Leakage Policy Lookup

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                          │
    │   Request Context: tenant_id=123, application_id=456                    │
    │                                                                          │
    │   Step 1: Check application_data_leakage_policies                       │
    │           WHERE tenant_id=123 AND application_id=456                    │
    │           Found: input_high_risk_action = NULL (not set)                │
    │                                                                          │
    │   Step 2: Check tenant_data_leakage_policies                            │
    │           WHERE tenant_id=123                                            │
    │           Found: default_input_high_risk_action = "switch_private_model"│
    │                                                                          │
    │   Result: input_high_risk_action = "switch_private_model"               │
    │                                                                          │
    └─────────────────────────────────────────────────────────────────────────┘

    Applied To:

    ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
    │   Risk Type Config   │  │  Data Leakage Policy │  │  Response Templates  │
    ├──────────────────────┤  ├──────────────────────┤  ├──────────────────────┤
    │ s1_enabled           │  │ high_risk_action     │  │ template_content     │
    │ s2_enabled           │  │ medium_risk_action   │  │ risk_level           │
    │ ...                  │  │ low_risk_action      │  │ scanner_identifier   │
    │ sensitivity_threshold│  │ private_model_id     │  │                      │
    └──────────────────────┘  └──────────────────────┘  └──────────────────────┘
```

---

## 8. 认证与权限流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     Authentication & Authorization Flow                          │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                      Supported Auth Methods                              │
    │                                                                          │
    │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │
    │   │    JWT Token    │  │    API Key      │  │   Switched Context      │ │
    │   │                 │  │                 │  │                         │ │
    │   │ Authorization:  │  │ Authorization:  │  │ X-Switch-User: {id}     │ │
    │   │ Bearer {jwt}    │  │ Bearer sk-xxai- │  │ (Super Admin Only)      │ │
    │   │                 │  │ {key}           │  │                         │ │
    │   └────────┬────────┘  └────────┬────────┘  └────────────┬────────────┘ │
    │            │                    │                        │              │
    │            └────────────────────┴────────────────────────┘              │
    │                                 │                                        │
    └─────────────────────────────────┼────────────────────────────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                      AuthContextMiddleware                               │
    │                                                                          │
    │   Parse Authorization Header                                            │
    │            │                                                             │
    │            ├── JWT Token? ─────> Verify JWT → Extract tenant_id         │
    │            │                                                             │
    │            ├── API Key? ───────> Lookup Key → Get tenant_id + app_id    │
    │            │                     ┌─────────────────────────────────┐    │
    │            │                     │ Priority:                        │    │
    │            │                     │ 1. Application API Key (new)     │    │
    │            │                     │ 2. Tenant API Key (legacy)       │    │
    │            │                     └─────────────────────────────────┘    │
    │            │                                                             │
    │            └── X-Switch-User? ──> Verify super_admin → Set switch_id    │
    │                                                                          │
    │   Auto-Discovery (X-OG-Application-ID Header):                          │
    │            │                                                             │
    │            └── Header Present? ──> Find/Create Application              │
    │                                    (source = 'auto_discovery')          │
    │                                                                          │
    └─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                         Auth Context Types                               │
    │                                                                          │
    │   ┌─────────────────────────────────────────────────────────────────┐   │
    │   │  Type                    │  Description                         │   │
    │   ├──────────────────────────┼──────────────────────────────────────┤   │
    │   │  jwt_admin               │  Super admin login (JWT)             │   │
    │   │  jwt                     │  Regular tenant login (JWT)          │   │
    │   │  jwt_switched            │  Switched user context (JWT+Switch)  │   │
    │   │  api_key                 │  Application API key                 │   │
    │   │  api_key_legacy          │  Tenant API key (backward compat)    │   │
    │   │  api_key_switched        │  API key with switch context         │   │
    │   │  tenant_api_key_consumer │  Tenant key + auto-discovered app    │   │
    │   └─────────────────────────────────────────────────────────────────┘   │
    │                                                                          │
    └─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                         Auth Cache (1h TTL)                              │
    │                                                                          │
    │   Cache Key: hash(token + switch_session)                               │
    │   Cache Value: {                                                         │
    │       tenant_id,                                                         │
    │       application_id,                                                    │
    │       is_super_admin,                                                    │
    │       auth_type,                                                         │
    │       switch_target_id                                                   │
    │   }                                                                      │
    │                                                                          │
    │   Benefits: Reduce DB queries, improve performance                      │
    │                                                                          │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 风险类型分类 (19 Types)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          19 Risk Categories (S1-S19)                             │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                         HIGH RISK (默认: REJECT)                         │
    │                                                                          │
    │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
    │   │   S2    │  │   S3    │  │   S5    │  │   S9    │  │   S15   │      │
    │   │敏感政治 │  │暴力犯罪 │  │提示攻击 │  │大规模杀 │  │ 性犯罪  │      │
    │   │ (PRC)   │  │Violence │  │ Prompt  │  │伤性武器 │  │ Sexual  │      │
    │   │Sensitive│  │ Crime   │  │ Attack  │  │  WMDs   │  │ Crime   │      │
    │   │Politics │  │         │  │         │  │         │  │         │      │
    │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘      │
    │                                                                          │
    │   ┌─────────┐                                                            │
    │   │   S17   │                                                            │
    │   │ 自残/   │                                                            │
    │   │ 自杀    │                                                            │
    │   │Self-harm│                                                            │
    │   └─────────┘                                                            │
    │                                                                          │
    │   处理: 使用预设响应模板，拒绝请求                                       │
    └─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                        MEDIUM RISK (默认: REPLACE)                       │
    │                                                                          │
    │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                    │
    │   │   S4    │  │   S6    │  │   S7    │  │   S16   │                    │
    │   │未成年人 │  │非暴力犯 │  │色情内容 │  │ 自残/   │                    │
    │   │ 伤害    │  │   罪    │  │Pornogra-│  │自杀诱导 │                    │
    │   │Child    │  │Non-viol-│  │  phy    │  │Self-harm│                    │
    │   │  Harm   │  │ent crime│  │         │  │ inducing│                    │
    │   └─────────┘  └─────────┘  └─────────┘  └─────────┘                    │
    │                                                                          │
    │   处理: 使用知识库匹配回答，替换原始响应                                 │
    └─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                         LOW RISK (默认: PASS)                            │
    │                                                                          │
    │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │
    │   │   S1    │  │   S8    │  │   S10   │  │   S11   │  │   S12   │      │
    │   │一般政治 │  │仇恨言论 │  │亵渎语言 │  │隐私侵犯 │  │商业风险 │      │
    │   │General  │  │  Hate   │  │Profanity│  │ Privacy │  │Commercial│      │
    │   │Politics │  │ Speech  │  │         │  │Violation│  │  Risks  │      │
    │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘      │
    │                                                                          │
    │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                    │
    │   │   S13   │  │   S14   │  │   S18   │  │   S19   │                    │
    │   │知识产权 │  │ 骚扰    │  │ 威胁    │  │专业建议 │                    │
    │   │   IP    │  │Harassm- │  │ Threats │  │Professio│                    │
    │   │Violation│  │  ent    │  │         │  │nal Adv  │                    │
    │   └─────────┘  └─────────┘  └─────────┘  └─────────┘                    │
    │                                                                          │
    │   处理: 允许通过，仅记录日志                                             │
    └─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                       Custom Scanners (S100+)                            │
    │                                                                          │
    │   用户自定义扫描器，支持三种类型:                                        │
    │                                                                          │
    │   ┌─────────┐  ┌─────────┐  ┌─────────┐                                 │
    │   │  GenAI  │  │  Regex  │  │ Keyword │                                 │
    │   │   型    │  │   型    │  │   型    │                                 │
    │   │AI模型检测│  │正则匹配 │  │关键词匹配│                                 │
    │   └─────────┘  └─────────┘  └─────────┘                                 │
    │                                                                          │
    │   标签分配: S1-S21 (内置), S22-S99 (保留), S100+ (自定义)               │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 10. 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Docker Compose Deployment                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Host Machine (GPU)                                  │
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         Docker Network                                     │  │
│  │                                                                            │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐   │  │
│  │  │                    openguardrails-platform                          │   │  │
│  │  │                        (Port 3000)                                  │   │  │
│  │  │  ┌─────────────────────────────────────────────────────────────┐   │   │  │
│  │  │  │                      Nginx                                   │   │   │  │
│  │  │  │   /platform/* → React UI (static files)                     │   │   │  │
│  │  │  │   /api/*      → Admin Service (127.0.0.1:5000)              │   │   │  │
│  │  │  │   /v1/*       → Detection/Proxy (127.0.0.1:5001/5002)       │   │   │  │
│  │  │  └─────────────────────────────────────────────────────────────┘   │   │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐    │   │  │
│  │  │  │   Admin     │  │  Detection  │  │        Proxy            │    │   │  │
│  │  │  │  Service    │  │   Service   │  │       Service           │    │   │  │
│  │  │  │ (2 workers) │  │(32 workers) │  │    (24 workers)         │    │   │  │
│  │  │  │  Port 5000  │  │  Port 5001  │  │     Port 5002           │    │   │  │
│  │  │  └─────────────┘  └─────────────┘  └─────────────────────────┘    │   │  │
│  │  │                                                                    │   │  │
│  │  │  entrypoint.sh: Wait for PG → Run Migrations → Start Services     │   │  │
│  │  └────────────────────────────────────────────────────────────────────┘   │  │
│  │                                    │                                       │  │
│  │                                    │ Database Connection                   │  │
│  │                                    ▼                                       │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐   │  │
│  │  │                    openguardrails-postgres                          │   │  │
│  │  │                        (Port 54321)                                 │   │  │
│  │  │                                                                     │   │  │
│  │  │   PostgreSQL 15 with healthcheck                                   │   │  │
│  │  │   Data Volume: ./data/postgres:/var/lib/postgresql/data            │   │  │
│  │  └────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                            │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐   │  │
│  │  │                    openguardrails-text-model                        │   │  │
│  │  │                        (Port 58002)                                 │   │  │
│  │  │                                                                     │   │  │
│  │  │   vLLM Server with OpenGuardrails-Text-2510 (3.3B)                 │   │  │
│  │  │   GPU: NVIDIA (requires CUDA)                                      │   │  │
│  │  │   Model Cache: ~/.cache/huggingface                                │   │  │
│  │  └────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                            │  │
│  │  ┌────────────────────────────────────────────────────────────────────┐   │  │
│  │  │                    openguardrails-embedding                         │   │  │
│  │  │                        (Port 58004)                                 │   │  │
│  │  │                                                                     │   │  │
│  │  │   vLLM Server with BAAI/bge-m3 (Embedding)                         │   │  │
│  │  │   GPU: NVIDIA (requires CUDA)                                      │   │  │
│  │  │   Used for: Knowledge Base similarity search                       │   │  │
│  │  └────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                            │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  External Ports:                                                                │
│  • 3000: Web UI & API Gateway                                                   │
│  • 54321: PostgreSQL (optional, for debugging)                                  │
│                                                                                  │
│  Volumes:                                                                       │
│  • ./data/postgres: Database persistence                                        │
│  • ~/.cache/huggingface: Model cache (auto-download)                           │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

    Quick Start:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  export HF_TOKEN=your-hf-token                                          │
    │  docker compose up -d                                                   │
    │                                                                          │
    │  Access: http://localhost:3000/platform/                                │
    │  Default: admin@yourdomain.com / CHANGE-THIS-PASSWORD-IN-PRODUCTION    │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 总结

OpenGuardrails 是一个企业级 AI 安全平台，主要特点包括：

1. **三层服务架构**: Admin (管理) + Detection (检测) + Proxy (代理)
2. **19 种风险类型检测**: 覆盖政治、暴力、提示攻击、数据泄露等
3. **智能数据泄露防护**: 格式感知分段 + 正则/GenAI 双检测
4. **私有模型自动切换**: 敏感数据自动路由到本地模型
5. **多层配置继承**: 系统 → 租户 → 应用，灵活配置
6. **Scanner Package 系统**: 内置 + 可购买 + 自定义扫描器
7. **滑动窗口检测**: 支持超长内容的安全检测

---

*Last Updated: 2026-01-26*
*Generated for: Technical Communication & Architecture Review*
